<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>簡易分帳系統</title>
    <script type="module">
        // Firebase 模組化導入
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAvnExZ-A9TG6K9XTlUrTrMSWQJXvKU2Pc",
            authDomain: "split-expenses-76fa3.firebaseapp.com",
            projectId: "split-expenses-76fa3",
            storageBucket: "split-expenses-76fa3.firebasestorage.app",
            messagingSenderId: "67801544086",
            appId: "1:67801544086:web:88313c1498360dfaff99b7"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const balanceRef = doc(db, "expenses", "balance");
        const historyRef = doc(db, "expenses", "history");

        let balance = 0;
        let historyData = [];
        
        function getCurrentTime() {
            return new Date().toISOString(); // 存成 UTC 標準時間
        }

        function formatLocalTime(utcString) {
            const localTime = new Date(utcString);
            const year = localTime.getFullYear();
            const month = String(localTime.getMonth() + 1).padStart(2, '0');
            const day = String(localTime.getDate()).padStart(2, '0');
            const hours = String(localTime.getHours()).padStart(2, '0');
            const minutes = String(localTime.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }
        
        async function updateBalance() {
            const balanceDisplay = document.getElementById("balance");
            if (balance > 0) {
                balanceDisplay.textContent = `目前帳務：Elmo 欠 Eura ${balance} 元`;
                balanceDisplay.className = "balance positive";
            } else if (balance < 0) {
                balanceDisplay.textContent = `目前帳務：Eura 欠 Elmo ${-balance} 元`;
                balanceDisplay.className = "balance negative";
            } else {
                balanceDisplay.textContent = "目前帳務：雙方均等";
                balanceDisplay.className = "balance neutral";
            }
            await setDoc(balanceRef, { balance });
        }
        
        async function addTransaction() {
            const descriptionInput = document.getElementById("description");
            const amountInput = document.getElementById("amount");
            const splitType = document.getElementById("split").value;
            
            const description = descriptionInput.value.trim();
            const amount = parseFloat(amountInput.value);
            
            if (!description) {
                alert("請輸入帳務名稱");
                return;
            }
            if (isNaN(amount) || amount <= 0) {
                alert("請輸入有效的金額");
                return;
            }
            const timestamp = getCurrentTime();
            
            if (splitType === "equal") {
                balance -= amount / 2;
            } else if (splitType === "fullElmo") {
                balance -= amount;
            } else if (splitType === "fullEura") {
                balance += amount;
            }
            
            historyData.push({ description, amount, splitType, timestamp });
            await saveHistory();
            await updateBalance();
            renderHistory();
            
            // 清空輸入框
            descriptionInput.value = "";
            amountInput.value = "";
        }
        
        function renderHistory() {
            const historyList = document.getElementById("history");
            historyList.innerHTML = "";
            historyData.forEach((item, index) => {
                const formattedTime = formatLocalTime(item.timestamp);
                const newRecord = document.createElement("li");
                newRecord.innerHTML = `${item.description} - ${item.amount} 元（${item.splitType === "equal" ? "平分" : item.splitType === "fullElmo" ? "Elmo 付全額" : "Eura 付全額"}） <span style='color:gray;'>${formattedTime}</span> <button onclick='deleteTransaction(${index})'>刪除</button>`;
                historyList.appendChild(newRecord);
            });
        }
        
        async function deleteTransaction(index) {
            historyData.splice(index, 1);
            await saveHistory();
            renderHistory();
        }
        
        async function saveHistory() {
            await setDoc(historyRef, { history: historyData });
        }
        
        async function loadStoredData() {
            try {
                const balanceDoc = await getDoc(balanceRef);
                if (balanceDoc.exists()) {
                    balance = balanceDoc.data().balance;
                }
                const historyDoc = await getDoc(historyRef);
                if (historyDoc.exists()) {
                    historyData = historyDoc.data().history;
                }
                renderHistory();
                updateBalance();
            } catch (error) {
                console.error("Firestore 載入錯誤: ", error);
            }
        }
        
        window.onload = loadStoredData;
        
        window.addTransaction = addTransaction;
        window.deleteTransaction = deleteTransaction;
        window.confirmReset = async function() {
            if (confirm("確定要重置帳務與交易紀錄嗎？此操作無法還原！")) {
                balance = 0;
                historyData = [];
                await setDoc(balanceRef, { balance: 0 });
                await setDoc(historyRef, { history: [] });
                renderHistory();
                updateBalance();
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <h2 style="text-align: center;">分帳計算</h2>
        <div class="balance neutral" id="balance">目前帳務：雙方均等</div>
        <label for="description">名稱：</label>
        <input type="text" id="description" placeholder="輸入帳務名稱">
        <label for="amount">金額：</label>
        <input type="number" id="amount" placeholder="輸入金額" min="1">
        <label for="split">分帳方式：</label>
        <select id="split">
            <option value="equal">平分</option>
            <option value="fullElmo">Elmo 付全額</option>
            <option value="fullEura">Eura 付全額</option>
        </select>
        <button onclick="addTransaction()">新增帳務</button>
        <button onclick="confirmReset()">重置帳務與紀錄</button>
        <h3>交易紀錄</h3>
        <ul id="history"></ul>
    </div>
</body>
</html>